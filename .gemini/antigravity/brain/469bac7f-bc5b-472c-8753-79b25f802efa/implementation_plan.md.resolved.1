# Audit Remediation Implementation Plan

**Goal:** Resolve all 10 issues identified in the AdhanLife Audit Report.
**Estimated Effort:** ~50 tool calls across 3 phases.

---

## User Review Required

> [!IMPORTANT]
> **Phase 1 (Critical)** requires immediate attention due to **security** and **UX** implications.
> **Phase 2 (Medium)** adds significant user value but requires more development time.
> **Phase 3 (Low)** is polish work that can be deferred.

**Please confirm scope:**
1. Should I proceed with **all 3 phases** or a subset?
2. For **IAP verification (Issue #1):** This requires a backend server. Do you have one, or should I implement a **mock/placeholder** for now?
3. For **Audio Playback (Issue #4, #6):** Do you have Quran recitation audio assets, or should I integrate a public API (e.g., Quran.com Audio)?

---

## Phase 1: Critical Fixes (Security/UX)

### Issue #1: IAP Server-Side Verification
**File:** [lib/core/services/purchase_service.dart](file:///c:/Users/Abdullah/Projects/AdhanLife/adhan_life/lib/core/services/purchase_service.dart)
**Problem:** [_verifyPurchase](file:///c:/Users/Abdullah/Projects/AdhanLife/adhan_life/lib/core/services/purchase_service.dart#126-132) returns `true` without actual verification.
**Solution:**
- **Option A (Production):** Implement backend call to verify receipt.
- **Option B (Placeholder):** Add comment and log warning, but ship with client-side trust (common for MVP).

### Issue #2: Onboarding Completion State
**File:** [lib/features/onboarding/presentation/screens/onboarding_screen.dart](file:///c:/Users/Abdullah/Projects/AdhanLife/adhan_life/lib/features/onboarding/presentation/screens/onboarding_screen.dart)
**Problem:** [_completeOnboarding()](file:///c:/Users/Abdullah/Projects/AdhanLife/adhan_life/lib/features/onboarding/presentation/screens/onboarding_screen.dart#162-167) has a TODO, state is not saved.
**Solution:** Call `StorageService.setOnboardingCompleted(true)` and redirect.

---

## Phase 2: Feature Completion (User Value)

### Issue #3: Implement Share Functionality
**Files:**
- [lib/features/home/presentation/widgets/next_prayer_card.dart](file:///c:/Users/Abdullah/Projects/AdhanLife/adhan_life/lib/features/home/presentation/widgets/next_prayer_card.dart) (Share button)
- [lib/features/quran/presentation/screens/surah_reader_screen.dart](file:///c:/Users/Abdullah/Projects/AdhanLife/adhan_life/lib/features/quran/presentation/screens/surah_reader_screen.dart) (Share Surah, Share Verse)

**Solution:**
- Add `share_plus` package (likely already added).
- Wire `Share.share()` with formatted text for each context.

### Issue #4: Quran Audio Playback
**File:** [lib/features/quran/presentation/screens/surah_reader_screen.dart](file:///c:/Users/Abdullah/Projects/AdhanLife/adhan_life/lib/features/quran/presentation/screens/surah_reader_screen.dart)
**Problem:** [_playVerse()](file:///c:/Users/Abdullah/Projects/AdhanLife/adhan_life/lib/features/quran/presentation/screens/surah_reader_screen.dart#274-277) is a stub.
**Solution:**
- Wire `QuranAudioService` which already exists.
- Use a public API for recitation audio (e.g., Quran.com or Everyayah.com).

### Issue #5: Dua Favorites
**File:** [lib/features/learning/presentation/screens/duas_screen.dart](file:///c:/Users/Abdullah/Projects/AdhanLife/adhan_life/lib/features/learning/presentation/screens/duas_screen.dart)
**Problem:** Favorite button is a stub.
**Solution:**
- Use `StorageService.toggleFavorite()` (already exists).
- Filter list on "Show Favorites" tap.

### Issue #6: Dua/Names Audio
**Files:** [duas_screen.dart](file:///c:/Users/Abdullah/Projects/AdhanLife/adhan_life/lib/features/learning/presentation/screens/duas_screen.dart), [names_screen.dart](file:///c:/Users/Abdullah/Projects/AdhanLife/adhan_life/lib/features/learning/presentation/screens/names_screen.dart)
**Problem:** Audio play buttons are stubs.
**Solution:**
- Wire `AudioService` to play from local assets or fetch from API.
- Audio assets required.

---

## Phase 3: Polish (Low Priority)

### Issue #7: Notification Tap Navigation
**File:** [lib/core/services/notification_service.dart](file:///c:/Users/Abdullah/Projects/AdhanLife/adhan_life/lib/core/services/notification_service.dart)
**Solution:** Use `GoRouter` to navigate based on `payload`.

### Issue #8: Quran Settings Persistence
**File:** `lib/features/settings/presentation/screens/quran_settings_screen.dart`
**Solution:** Call [StorageService](file:///c:/Users/Abdullah/Projects/AdhanLife/adhan_life/lib/core/services/storage_service.dart#53-343) to save/load font size and translation.

### Issue #9: Home Notification Icon
**File:** [lib/features/home/presentation/screens/home_screen.dart](file:///c:/Users/Abdullah/Projects/AdhanLife/adhan_life/lib/features/home/presentation/screens/home_screen.dart)
**Solution:** Navigate to `/settings/notifications` on tap.

### Issue #10: Rate App Button
**File:** `lib/features/settings/presentation/screens/settings_screen.dart`
**Solution:** Use `url_launcher` to open Play Store / App Store URL.

---

## Cleanup: Dead Code Removal

| File | Action |
|------|--------|
| [city_search_screen.dart](file:///c:/Users/Abdullah/Projects/AdhanLife/adhan_life/lib/features/settings/presentation/screens/city_search_screen.dart) | Delete (replaced by `LocationSelectionScreen`) |
| [widget_service.dart](file:///c:/Users/Abdullah/Projects/AdhanLife/adhan_life/lib/core/services/widget_service.dart) | Delete or defer (Home Widget feature not in scope) |

---

## Verification Plan

After implementing each phase:
1. Run `flutter build apk` to ensure no compile errors.
2. Manual test on device for each fixed feature.
3. Update [task.md](file:///c:/Users/Abdullah/.gemini/antigravity/brain/469bac7f-bc5b-472c-8753-79b25f802efa/task.md) with progress.

