Ğ# ğŸ§ª Flutter Testing Grimoire

> **Owner:** QA Lead / Tech Lead
> **Purpose:** Comprehensive testing strategies from Unit to Integration, including Golden Tests.

---

## ğŸ“Š The Testing Pyramid

| Level | Speed | Scope | Count |
|-------|-------|-------|-------|
| **Unit** | âš¡ Fast | Single function/class | Many |
| **Widget** | âš¡ Fast | Single widget | Many |
| **Integration** | ğŸ¢ Slow | Full app flow | Few |
| **Golden** | ğŸ¢ Slow | Visual regression | Medium |

---

## ğŸ§¬ Unit Tests

### Basic Pattern
```dart
void main() {
  group('Calculator', () {
    test('adds two numbers', () {
      final calc = Calculator();
      expect(calc.add(2, 3), equals(5));
    });

    test('throws on division by zero', () {
      final calc = Calculator();
      expect(() => calc.divide(10, 0), throwsArgumentError);
    });
  });
}
```

### Mocking with Mocktail
```dart
import 'package:mocktail/mocktail.dart';

class MockUserRepository extends Mock implements UserRepository {}

void main() {
  late MockUserRepository mockRepo;

  setUp(() {
    mockRepo = MockUserRepository();
  });

  test('fetches user', () async {
    when(() => mockRepo.getUser(any())).thenAnswer((_) async => User(id: '1'));
    
    final user = await mockRepo.getUser('1');
    expect(user.id, '1');
    verify(() => mockRepo.getUser('1')).called(1);
  });
}
```

---

## ğŸ§© Widget Tests

### Basic Pattern
```dart
void main() {
  testWidgets('Counter increments', (tester) async {
    await tester.pumpWidget(MaterialApp(home: CounterPage()));

    expect(find.text('0'), findsOneWidget);

    await tester.tap(find.byIcon(Icons.add));
    await tester.pump(); // Rebuild

    expect(find.text('1'), findsOneWidget);
  });
}
```

### Finders
| Finder | Use |
|--------|-----|
| `find.text('Hello')` | By text |
| `find.byType(ElevatedButton)` | By widget type |
| `find.byKey(Key('submit'))` | By key |
| `find.byIcon(Icons.add)` | By icon |
| `find.ancestor(of:, matching:)` | Find parent |
| `find.descendant(of:, matching:)` | Find child |

### Matchers
| Matcher | Use |
|---------|-----|
| `findsOneWidget` | Exactly 1 |
| `findsNothing` | 0 |
| `findsNWidgets(3)` | Exactly N |
| `findsAtLeastNWidgets(1)` | N or more |

---

## ğŸ–¼ï¸ Golden Tests (Visual Regression)

### Setup
```dart
void main() {
  testWidgets('Button matches golden', (tester) async {
    await tester.pumpWidget(MaterialApp(home: MyButton()));
    
    await expectLater(
      find.byType(MyButton),
      matchesGoldenFile('goldens/my_button.png'),
    );
  });
}
```

### Generate Goldens
```bash
flutter test --update-goldens
```

### CI Strategy
*   Store goldens in `test/goldens/`.
*   Commit to Git.
*   CI runs `flutter test` and fails if pixels differ.

---

## ğŸš€ Integration Tests (with Patrol)

### Setup
```yaml
dev_dependencies:
  patrol: ^3.0.0
  patrol_finders: ^2.0.0
```

### Test File
```dart
import 'package:patrol/patrol.dart';

void main() {
  patrolTest('login flow', ($) async {
    await $.pumpWidgetAndSettle(MyApp());

    await $(#emailField).enterText('test@test.com');
    await $(#passwordField).enterText('password');
    await $(#loginButton).tap();

    await $.native.grantPermissionWhenInUse(); // Native permission

    expect($(#homePage), findsOneWidget);
  });
}
```

### Run
```bash
patrol test -t integration_test/login_test.dart
```

---

## ğŸ” BLoC Testing

```dart
blocTest<CounterBloc, int>(
  'emits [1] when increment is added',
  build: () => CounterBloc(),
  act: (bloc) => bloc.add(IncrementEvent()),
  expect: () => [1],
);
```

---

## âš ï¸ Common Mistakes

| âŒ Bad | âœ… Good |
|--------|---------|
| `await tester.pump()` after navigation | `await tester.pumpAndSettle()` |
| Hardcoded text in finders | Use Keys |
| No mocking in widget tests | Mock all dependencies |
| Skipping Golden updates | Commit updated Goldens |
Ğ*cascade082>file:///C:/Users/Abdullah/.gemini/knowledge/flutter_testing.md